name: Generate New Films Content

on:
  workflow_dispatch:
  schedule:
    # Run every Sunday at 7pm UTC (shows new films added Mon-Sun this week)
    - cron: "0 19 * * 0"

jobs:
  generate:
    name: Generate content
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Download combined data
        uses: clusterflick/release-downloader@v1
        with:
          token: ${{ secrets.PAT }}
          repository: "clusterflick/data-combined"
          latest: true
          fileName: "*"
          out-file-path: "combined-data"

      - name: Download matched data
        uses: clusterflick/release-downloader@v1
        with:
          token: ${{ secrets.PAT }}
          repository: "clusterflick/data-matched"
          latest: true
          fileName: "*"
          out-file-path: "matched-data"

      - name: Generate new films content
        run: npm run generate:new-films

      - name: Take screenshot
        run: npm run screenshot:new-films

      - name: Upload text outputs
        uses: actions/upload-artifact@v4
        with:
          name: social-media-text
          path: |
            output/new-films-twitter_*.txt
            output/new-films-instagram_*.txt
            output/new-films-generic_*.txt

      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        with:
          name: screenshot
          path: output/new-films_*.png

      - name: Upload HTML
        uses: actions/upload-artifact@v4
        with:
          name: html
          path: site/new-films.html
